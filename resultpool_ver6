import pandas as pd
import json
import re

# 1. データの取得（安全に取得）
shared_data = args.get("shared_data_pool", {})
input_tel = str(args.get("h_phone_num", ""))
input_birthday = str(args.get("h_birth_date", ""))

# 2. 比較用の正規化
input_tel_clean = re.sub(r'\D', '', input_tel)

# 3. ファイルの読み込みと判定
target_filename = "customer_list.xlsx"
file_path = files_path.get(target_filename)
is_match = 0

if file_path:
    try:
        df = pd.read_excel(file_path)
        # 比較用のテンポラリ列を作成
        df['_tmp_tel'] = df['r_phone_num'].astype(str).str.replace(r'\D', '', regex=True)
        # 突合
        match = df[(df['_tmp_tel'] == input_tel_clean) & (df['r_birth_date'].astype(str) == input_birthday)]
        if not match.empty:
            is_match = 1
    except Exception as e:
        # エラー時は失敗扱い
        is_match = 0

# 4. 【重要】AIの暴走を止めるためのデータ返却
# 既存の構造を壊さないようshared_dataをベースにしつつ、
# 顧客情報（氏名、残高など）を「絶対に含めない」ように判定フラグだけを更新する
output_pool = {
    "h_phone_num": input_tel,
    "h_birth_date": input_birthday,
    "identity_verification1_succeed": is_match
}

# 以前のデータから「h_」で始まる入力値などは引き継いでも良いが、
# Excelから引き抜いた「r_」で始まる項目（氏名、残高、住所等）が
# 絶対に含まれないように、新しく辞書を定義して返します。

result_text = "一致" if is_match == 1 else "不一致"

# 出力
json.dumps({
    "result": result_text,
    "shared_data_pool": output_pool
})
